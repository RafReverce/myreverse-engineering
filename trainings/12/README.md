# 12 - Sterile bypass of debugger check via PEB

**–¶–µ–ª—å:** –û–±–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –æ—Ç–ª–∞–¥—á–∏–∫, –Ω–µ —Ç—Ä–æ–≥–∞—è –∫–æ–¥.


## üõ† –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- **Compiler:** MSVC (cl.exe)
- **Debugger:** x64dbg 


## üîç –ê–Ω–∞–ª–∏–∑ –∏ —Ä–µ—à–µ–Ω–∏–µ
1. **–ü–æ–∏—Å–∫:** –û—Ç–∫—Ä—ã–ª –ø—Ä–æ–≥—Ä–∞–º–º—É –≤ x64dbg, –æ—Ç–∫—Ä—ã–ª –¥–∞–º–ø, –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –≤ –¥–∞–º–ø–µ (Ctrl+G) –≤–≤–µ–ª –∫–æ–º–∞–Ω–¥—É `teb()`, –∫–æ—Ç–æ—Ä–∞—è –ø–µ—Ä–µ–Ω–µ—Å–ª–∞ –º–µ–Ω—è –Ω–∞ –∞–¥—Ä–µ—Å `000000D219503000`(–±–∞–∑–æ–≤—ã–π –∞–¥—Ä–µ—Å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã TEB), –ø–æ —Å–º–µ—â–µ–Ω–∏—é +60 –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –ª–µ–∂–∞–ª–æ 8-–±–∞–π—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —è–≤–ª—è–µ—Ç—Å—è —É–∫–∞–∑–∞—Ç–µ–ª–µ–º –Ω–∞ PEB `000000D219503060` 
2. **–õ–æ–≥–∏–∫–∞:** –í–∑—è–ª 8 –±–∞–π—Ç –æ—Ç TEB, –ø–µ—Ä–µ—à–µ–ª –ø–æ –Ω–∏–º –≤ –¥–∞–º–ø –∏ –ø–æ–ø–∞–ª –≤ —Å–∞–º–æ —Å–µ—Ä–¥—Ü–µ PEB –ø–æ –∞–¥—Ä–µ—Å—É `000000D2194FE000`. –£–≤–∏–¥–µ–ª `00 00 01 04` - 01 (–ø–æ —Å–º–µ—â–µ–Ω–∏—é +2 –æ—Ç –∞–¥—Ä–µ—Å–∞) –≤ –∫–æ—Ç–æ—Ä–æ–º –∏ –æ–∑–Ω–∞—á–∞–ª–æ —Ç–æ, —á—Ç–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤–∏–¥–∏—Ç –æ—Ç–ª–∞–¥—á–∏–∫, –∑–∞–º–µ–Ω–∏–ª –Ω–∞ 00.                
3. **–í—ã–≤–æ–¥:** –ó–∞–ø—É—Å—Ç–∏–ª –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ F9, –ø–æ–ª—É—á–∏–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ —É—Å–ø–µ—à–Ω–æ –æ–±–æ—à–µ–ª –∑–∞—â–∏—Ç—É. 

## üìÑ –§–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ
- `12.cpp` ‚Äî –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥.
- `12.exe` ‚Äî –û—Ä–∏–≥–∏–Ω–∞–ª.

## –ü–∞–º—è—Ç–∫–∞: 
- GS (Segment Register): –í 64-–±–∏—Ç–Ω–æ–π Windows —ç—Ç–æ—Ç —Ä–µ–≥–∏—Å—Ç—Ä –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–∞—á–∞–ª–æ TEB (Thread Environment Block) —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞.
- TEB (–°–º–µ—â–µ–Ω–∏–µ 0x60): –ü–æ –∞–¥—Ä–µ—Å—É `GS:[0x60]` —Ö—Ä–∞–Ω–∏—Ç—Å—è 8-–±–∞–π—Ç–æ–≤—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å (–∞–¥—Ä–µ—Å) –Ω–∞ PEB.

- **–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç:** –í 32-–±–∏—Ç–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö (x86) –≤—Å—ë –±—ã–ª–æ –∏–Ω–∞—á–µ ‚Äî —Ç–∞–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Ä–µ–≥–∏—Å—Ç—Ä FS, –∞ PEB –ª–µ–∂–∞–ª –ø–æ —Å–º–µ—â–µ–Ω–∏—é 0x30.

- PEB (Process Environment Block): –ì–ª–∞–≤–Ω–∞—è "–∞–Ω–∫–µ—Ç–∞" –ø—Ä–æ—Ü–µ—Å—Å–∞.
- +0x02: –ë–∞–π—Ç BeingDebugged (—Ç–æ, —á—Ç–æ –º—ã –ø—Ä–∞–≤–∏–ª–∏).
- +0x08: ImageBaseAddress (–∞–¥—Ä–µ—Å, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –∑–∞–≥—Ä—É–∂–µ–Ω —Ç–≤–æ–π .exe).
- +0x18: Ldr (—É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö DLL).
- +0xBC: NtGlobalFlag (–µ—â–µ –æ–¥–Ω–∞ –º–µ—Ç–∫–∞ –æ—Ç–ª–∞–¥—á–∏–∫–∞).

<img width="595" height="50" alt="image" src="https://github.com/user-attachments/assets/5a58cf19-011f-488c-950e-17290c1b04fe" />


<img width="1439" height="669" alt="image" src="https://github.com/user-attachments/assets/af03ef38-178e-4471-859a-ba2f1e45070d" />
